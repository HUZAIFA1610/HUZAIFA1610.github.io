---
import Layout from "../layouts/Layout.astro";
import { projects } from "../data/projects";

// Sort: featured first, then category, then title
const sortedProjects = [...projects].sort((a, b) => {
  const af = a.featured ? 0 : 1;
  const bf = b.featured ? 0 : 1;
  if (af !== bf) return af - bf;

  const cat = a.category.localeCompare(b.category);
  if (cat !== 0) return cat;

  return a.title.localeCompare(b.title);
});

const categories = ["All", ...Array.from(new Set(sortedProjects.map((p) => p.category)))];
---



<Layout
  title="Projects | Mohammad Abu Huzaifa"
  description="Selected data analytics projects: dashboards, EDA, predictive insights, and reporting."
>
  <h1 class="text-3xl font-semibold tracking-tight">Projects</h1>
  <p class="mt-2 text-slate-300 max-w-2xl">
    Curated projects with clear problem framing, approach, and measurable outcomes.
  </p>

  <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex-1">
      <label for="project-search" class="sr-only">Search projects</label>
      <input
        id="project-search"
        type="search"
        placeholder="Search by title, tech stack, or keywords…"
        class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-slate-100 placeholder:text-slate-400 outline-none focus:border-white/20"
      />
      <p class="mt-2 text-xs text-slate-400">
        Tip: try “Power BI”, “FastAPI”, “R”, “forecast”, “anomaly”, “MySQL”
      </p>
    </div>

    <div class="text-sm text-slate-300">
      <span class="text-slate-400">Showing:</span>
      <span id="project-count">0</span>
    </div>
  </div>

  <div class="mt-6 flex flex-wrap gap-2" id="project-filters">
    {categories.map((c) => (
      <button
        type="button"
        data-filter={c}
        class="rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm text-slate-200 hover:bg-white/10 transition"
      >
        {c}
      </button>
    ))}
  </div>

  <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
  {sortedProjects.map((p) => (
    <article
      class="rounded-xl border border-white/10 bg-white/5 overflow-hidden hover:bg-white/10 transition"
      data-category={p.category}
      data-search={`${p.title} ${p.oneLiner} ${p.stack.join(" ")}`.toLowerCase()}
    >

      <a href={`/projects/${p.slug}`} class="block">
        <div class="aspect-[16/9] bg-black/30 overflow-hidden">
          <img
            src={p.coverImage}
            alt={`${p.title} cover`}
            class="h-full w-full object-cover opacity-90"
            loading="lazy"
            onerror="this.onerror=null;this.src='/images/placeholder.svg';"
          />
        </div>

        <div class="p-5">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs text-slate-400">{p.category} • {p.dataset}</div>

            {p.featured ? (
            <span class="text-[11px] rounded-full border border-sky-400/30 bg-sky-400/10 px-2 py-1 text-sky-200">
            Featured
            </span>
            ) : null}
          </div>
          <div class="mt-1 font-semibold">{p.title}</div>
          <div class="mt-2 text-sm text-slate-300">{p.oneLiner}</div>
        </div>
      </a>

      <div class="px-5 pb-5 flex gap-3">
        <a class="text-sm text-sky-400 hover:underline" href={`/projects/${p.slug}`}>
          Case study →
        </a>
        <a class="text-sm text-slate-300 hover:text-white" href={p.repoUrl} target="_blank">
          GitHub →
        </a>
      </div>
    </article>
  ))}
  </div>
  <script>
    const filtersEl = document.getElementById("project-filters");
    const buttons = filtersEl ? Array.from(filtersEl.querySelectorAll("button[data-filter]")) : [];
    const cards = Array.from(document.querySelectorAll("article[data-category]"));
    const searchInput = document.getElementById("project-search");
    const countEl = document.getElementById("project-count");

    function setActiveButton(value) {
      for (const btn of buttons) {
        const isActive = btn.dataset.filter === value;
        btn.classList.toggle("bg-white/10", isActive);
        btn.classList.toggle("border-white/20", isActive);
        btn.classList.toggle("text-white", isActive);
      }
    }

    function getState() {
      const url = new URL(window.location.href);
      const cat = url.searchParams.get("cat") || "All";
      const q = url.searchParams.get("q") || "";
      return { cat, q };
    }

    function setState({ cat, q }) {
      const url = new URL(window.location.href);
      if (!cat || cat === "All") url.searchParams.delete("cat");
      else url.searchParams.set("cat", cat);

      if (!q) url.searchParams.delete("q");
      else url.searchParams.set("q", q);

      window.history.replaceState({}, "", url);
    }

    function applyFilters({ cat, q }) {
      const selectedCat = cat || "All";
      const query = (q || "").trim().toLowerCase();

      let shown = 0;

      for (const card of cards) {
        const cardCat = card.getAttribute("data-category") || "";
        const hay = card.getAttribute("data-search") || "";

        const matchCat = selectedCat === "All" || cardCat === selectedCat;
        const matchQ = !query || hay.includes(query);

        const show = matchCat && matchQ;
        card.style.display = show ? "" : "none";
        if (show) shown += 1;
      }

      setActiveButton(selectedCat);
      if (countEl) countEl.textContent = String(shown);
    }

    // Init from URL
    const initial = getState();
    if (searchInput) searchInput.value = initial.q;
    applyFilters(initial);

    // Category clicks
    for (const btn of buttons) {
      btn.addEventListener("click", () => {
        const next = { ...getState(), cat: btn.dataset.filter || "All" };
        setState(next);
        applyFilters(next);
      });
    }

    // Search typing (debounced)
    let t;
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        window.clearTimeout(t);
        t = window.setTimeout(() => {
          const next = { ...getState(), q: searchInput.value || "" };
          setState(next);
          applyFilters(next);
        }, 120);
      });
    }
  </script>
</Layout>